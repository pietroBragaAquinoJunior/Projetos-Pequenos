<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <title>Json to Java</title>
    <script src="https://code.jquery.com/jquery-4.0.0.slim.js" integrity="sha256-M+GjhMBfXikM1izMplICCTscIj5hzPCp6uDzaypxtgg=" crossorigin="anonymous"></script>
  </head>
  <body>
    <header>
      <h1>Json to Java</h1>
    </header>
    <main>
      <div class="container">
        <div>
          <h2>Json Area</h2>
          <textarea class="area" id="json"></textarea>
        </div>
        <div>
          <h2>Java Area</h2>
          <textarea class="area" id="java"></textarea>
        </div>
        <div>
          <h2>Example Area</h2>
          <textarea class="area" id="exemplo">
            {
              "data": [
                {
                  "MainId": 1111,
                  "firstName": "Sherlock",
                  "lastName": "Homes",
                  "categories": [
                    {
                      "CategoryID": 1,
                      "CategoryName": "Primeira Categoria"
                    },
                    {
                      "CategoryID": 2,
                      "CategoryName": "Segunda Categoria",
                      "CategorySurpriseMotherFucker": "Category Surprise MotherFucker"
                    }
                  ]
                },
                {
                  "MainId": 122,
                  "firstName": "James",
                  "lastName": "Watson",
                  "categories": [
                    {
                      "CategoryID": 2,
                      "CategoryName": "Example2"
                    }
                  ]
                }
              ],
              "messages": [],
              "success": true
            }
          </textarea>
        </div>
      </div>
      <p class="message"></p>
      <button id="convertButton">Converter</button>
    </main>
    <footer></footer>
    <script>

      // Resetar Valores ao Abrir a página.
      $(document).ready(function(){
        $("#json").val("");
        $("#java").val("");
      });

      // Regex para encontrar vírgulas.
      const commaReGlobalPattern = /,/g;

      // Contar número de ocorrências do regex.
      const countNumberOccurences = function(string, pattern){
        return ( (string || "").match(pattern) || []).length
      }

      // Retornar array com as ocorrências do regex.
      const jsonOcurrences = function(string, pattern){
        return JSON.stringify(string.match(pattern));
      }

      // Verificar se o Json é válido.
      const validarJson = function(){
        var jsonContent = $("#json").val();
        try{
          var jsonObject = JSON.parse(jsonContent);
          $(".message").text("Json válido!")
          $(".message").css("color", "green");
          return true;
        }catch(e){
          $(".message").text("Json inválido!");
          $(".message").css("color", "red");
          return false;
        }
      }

      // Chamar verificação de Json para cada mudança no textArea.
      $("#json").on("input paste", function(){
        validarJson();
      });

      // Função auxiliar para não perder atributos caso eles apareçam no segundo item do array
      // dentro do json.
      const unirAtributos = function(arrayObject){
        // percorrer array
        for(var itemArray of arrayObject){
          // percorrer os objetos json
          for(var keyJsonObject in itemArray){
            // Se o primeiro item do array não tiver a chave desse objeto, adiciona.
            if(arrayObject[0].hasOwnProperty(keyJsonObject) === false){
              arrayObject[0][keyJsonObject] = itemArray[keyJsonObject];
            }
          }
        }
        // Retorna apenas o primeiro item, pois agora ele tem todos os atributos.
        return arrayObject[0];
      }

      // Deixar primeira letra da string maiúscula.
      function capitalizeFirstLetter(val) {
        return String(val).charAt(0).toUpperCase() + String(val).slice(1);
      }

      // Função auxiliar para conversão de json para pojo java.
      const oneJsonToJava = function(nomeJson){
      //   var json = JSON.parse(`
      // {
      //   "users": [ "teste" ],
      //   "total": 3
      // }
      //   `)
        var dtoJava = `public class ${nomeJson != null ? nomeJson : "UNDEFINED"} {`
        for(key in json){
          switch(typeof json[key]){
            case "object":
              if(Array.isArray(json[key])){
                dtoJava += `private ArrayList<${capitalizeFirstLetter(json[key])}> ${json[key]};`
              }else{
                dtoJava += `private Object ${json[key]};`
              }
              break;
            case "number":
              dtoJava += `private int ${json[key]};`
              break;
            case "boolean":
              dtoJava += `private boolean ${json[key]};`
              break;
            case "string":
              dtoJava += `private String ${json[key]};`
              break;
            default:
              dtoJava += `private UNDEFINED ${json[key]};`
          }
        }
        return dtoJava.concat("}")
      }

      const forInNestedJson = function(json){
        for(var key in json){
          if(typeof json[key] === "object" && !Array.isArray(json[key])){
            forInNestedJson(json[key]);
          }else{
            console.log(json[key])
          }
        }
      }

      $("#convertButton").on("click", function(){
        var jsonContent = $("#json").val();
        var valido = validarJson();
        if(valido === true){
          // Aqui eu já faço o Parse do json, usando o reviver. Não quero array.
          // Se for array, eu quero apenas o primeiro objeto do array. (Simplificar)
          // Existe um problema aqui. Se o primeiro json tiver menos parâmetros que o segundo
          // Esses parâmetros teoricamente serão perdidos.
          // pra resolver isso coloquei o unirAtributos.
          var jsonComArraySingular = JSON.parse(jsonContent,
            function (key, value){
              return Array.isArray(value) === true ? [unirAtributos(value)] : value;
            }
          )

          // $("#java").val(JSON.stringify(jsonComArraySingular));
          // $("#java").val(oneJsonToJava("Root"));
          forInNestedJson(jsonComArraySingular);


          // Agora o desafio é fazer função em profundidade, onde o último item
          // deve retornar uma string da representação dele em java
          // o penúltimo deve passar o nome do objeto filho, e receber a string e anexar ao corpo. (caso exista)


        }
      });

    </script>
  </body>
</html>

<style>
  .container{
    display:flex;
  }
  .area{
    width:275px;
    height:500px;
  }
</style>
